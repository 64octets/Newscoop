#!/usr/bin/php
<?php

if (!is_array($GLOBALS['argv'])) {
	echo "\n";
	echo "Can't read command line arguments\n";
	echo "\n";
	exit(1);
}

$CAMPSITE_DIR = dirname(dirname(__FILE__));
$ETC_DIR = $CAMPSITE_DIR . '/conf';

require_once("cli_script_lib.php");

if (!camp_is_readable("$ETC_DIR/install_conf.php")) {
	exit(1);
}

// include install_conf.php file
require_once("$ETC_DIR/install_conf.php");

$help = false;
$silent = false;
for ($i = 0; ; $i++) {
	if (!isset($GLOBALS['argv'][$i])) {
		break;
	}
	$arg = trim($GLOBALS['argv'][$i]);
        $help |= ($arg == "--help");
	$silent |= ($arg == "--silent");
}

if (!$silent) {
	echo "\n";
	echo "Campsite UTF8 Converter Utility\n";
	echo "-------------------------------\n";
}

$usage =
"  Usage:
  campsite-utf8-converter [--silent]

  This script will convert all of your website character and text
  data in database to utf8 character set.

  Parameters:
    --help
        Show this help and exit.

    --silent
        Don't display any messages on success.

  See also:
      campsite-backup
      campsite-restore

";

if (empty($ETC_DIR) || $help == true) {
	echo $usage;
	exit(1);
}

if (!is_file("$ETC_DIR/database_conf.php")) {
	echo "\n";
	echo "Database configuration file is missing!\n";
	echo "\n";
	exit(1);
}
require_once("$ETC_DIR/database_conf.php");

if (!$silent) {
        echo "UTF8 Converter script version: ".$Campsite["VERSION"]."\n";
        echo "Converting up the database...\n";
}

camp_utf8_convert();


function camp_utf8_convert()
{
    global $Campsite;

    // Connects to database server
    camp_connect_to_database();

    //
    $sql = 'ALTER DATABASE ' . $Campsite['DATABASE_NAME'] . ' CHARACTER SET utf8';
    if (!($res = mysql_query($sql))) {
        camp_exit_with_error("Unable to convert database charset to utf8");
    }

    //
    $sql = 'SET character_set_client = utf8';
    if (!($res = mysql_query($sql))) {
        camp_exit_with_error("Unable to convert the client charset to utf8");
    }

    // Builds ALTER TABLE sql queries for all database tables
    $sql = "SELECT CONCAT('ALTER TABLE ', table_schema, '.', table_name, ' CONVERT TO CHARACTER SET utf8') FROM information_schema.tables WHERE table_schema = '" . $Campsite['DATABASE_NAME'] . "'";
    $sqlSentences = null;
    $res = mysql_query($sql);
    while ($row = mysql_fetch_row($res)) {
       $sqlSentences[] = $row[0];
    }

    if (!is_array($sqlSentences)) {
        $sqlSentences = array();
    }
    foreach ($sqlSentences as $sentence) {
        if (!($res = mysql_query($sentence))) {
            camp_exit_with_error("Unable to convert data to utf8");
        }
    }

    return true;
} // fn camp_utf8_convert

if (!$silent) {
	echo "done.\n";
}

exit(0);

?>
