#!/usr/bin/php
<?php

if (!is_array($GLOBALS['argv'])) {
	echo "\n";
	echo "Can't read command line arguments\n";
	echo "\n";
	exit(1);
}

$CAMPSITE_DIR = dirname(dirname(__FILE__));
$ETC_DIR = $CAMPSITE_DIR . '/conf';

require_once("cli_script_lib.php");

if (!camp_is_readable("$ETC_DIR/install_conf.php")) {
	exit(1);
}

// include install_conf.php file
require_once("$ETC_DIR/install_conf.php");

$usage =
"  Usage:
  campsite-utf8-converter [--help] [--log] [--silent]

  This script will convert all of your website character and text
  data in database to utf8 character set.

  Parameters:
    --help
        Show this help and exit.

    --log=LOG_FILE
        Records the sql queries in the specified file.

    --silent
        Don't display any messages on success.

  See also:
      campsite-backup
      campsite-restore

";


$silent = false;

// gets the arguments from command line, if any
for ($i = 1; isset($GLOBALS['argv'][$i]); $i++) {
    $option = explode('=', $GLOBALS['argv'][$i]);
    switch ($option[0]) {
        case '--log':
            $log_file = !empty($option[1]) ? rtrim($option[1], '/') : '';
            if (empty($log_file)) {
                echo "Error: Log file not specified!\n\n";
                echo $usage;
                exit(1);
            }
            break;
        case '--silent':
            $silent = true;
            break;
        case '--help':
            echo $usage;
            exit(0);
        default:
            echo "Error: Invalid option '" . $option[0] . "'!\n\n";
            echo $usage;
            exit(1);
    }
}

if (!$silent) {
	echo "\n";
	echo "Campsite UTF8 Converter Utility\n";
	echo "-------------------------------\n";
}

if (empty($ETC_DIR)) {
	echo $usage;
	exit(1);
}

if (!is_file("$ETC_DIR/database_conf.php")) {
	echo "\n";
	echo "Database configuration file is missing!\n";
	echo "\n";
	exit(1);
}
require_once("$ETC_DIR/database_conf.php");

if (!$silent) {
        echo "UTF8 Converter script version: ".$Campsite["VERSION"]."\n";
        echo "Converting up the database...\n";
}

camp_utf8_convert($log_file);


function camp_utf8_convert($p_log_file)
{
    global $Campsite;

    // Connects to database server
    camp_connect_to_database();

    // Whether logging or not
    $do_log = (!empty($p_log_file)) ? true : false;
    if ($do_log) {
        if (!file_exists($p_log_file) || !is_writable($p_log_file)) {
            $do_log = false;
            camp_exit_with_error("Log file is missed or not writable!\n");
        }
    }

    // Sets the character set for the database
    $sql = 'ALTER DATABASE ' . $Campsite['DATABASE_NAME'] . ' CHARACTER SET utf8';
    if (!($res = mysql_query($sql))) {
        camp_exit_with_error("Unable to convert database charset to utf8");
    }
    if ($do_log) {
        $log_text = $sql . "\n";
    }

    // Sets the character set for the client
    $sql = 'SET character_set_client = utf8';
    if (!($res = mysql_query($sql))) {
        camp_exit_with_error("Unable to convert the client charset to utf8");
    }
    if ($do_log) {
        $log_text .= $sql . "\n";
    }

    // Builds ALTER TABLE sql queries for all database tables
    $sql = "SELECT CONCAT('ALTER TABLE ', table_schema, '.', table_name, ' CONVERT TO CHARACTER SET utf8') FROM information_schema.tables WHERE table_schema = '" . $Campsite['DATABASE_NAME'] . "'";
    $sqlSentences = null;
    $res = mysql_query($sql);
    while ($row = mysql_fetch_row($res)) {
       $sqlSentences[] = $row[0];
    }

    if (!is_array($sqlSentences)) {
        $sqlSentences = array();
    }
    foreach ($sqlSentences as $sentence) {
        if (!($res = mysql_query($sentence))) {
            camp_exit_with_error("Unable to convert data to utf8");
        } elseif ($do_log) {
            $log_text .= $sentence . "\n";
        }
    }

    // Deletes data from ArticleIndex and KeywordIndex tables to fix duplicate values
    $sql = 'DELETE FROM ' . $Campsite['DATABASE_NAME'] . '.ArticleIndex';
    if (!($res = mysql_query($sql))) {
        camp_exit_with_error("Unable to remove article index data");
    } elseif ($do_log) {
        $log_text .= $sql . "\n";
    }

    $sql = 'DELETE FROM ' . $Campsite['DATABASE_NAME'] . '.KeywordIndex';
    if (!($res = mysql_query($sql))) {
        camp_exit_with_error("Unable to remove keyword index data");
    } elseif ($do_log) {
        $log_text .= $sql . "\n";
    }

    $sql = 'UPDATE ' . $Campsite['DATABASE_NAME'] . ".Articles SET IsIndexed = 'N'";
    if (!($res = mysql_query($sql))) {
        camp_exit_with_error("Unable to update article table data");
    } elseif ($do_log) {
        $log_text .= $sql . "\n";
    }

    // Writes Log file
    if ($do_log) {
        if (@file_put_contents($p_log_file, $log_text) === false) {
            camp_exit_with_error("Couldn't write Log file");
        }
    }

    return true;
} // fn camp_utf8_convert

if (!$silent) {
	echo "done.\n";
}

exit(0);

?>
