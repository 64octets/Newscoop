#!/usr/bin/php
<?php

if (!is_array($GLOBALS['argv'])) {
	echo "\n";
	echo "Can't read command line arguments\n";
	echo "\n";
	exit(1);
}

$CAMPSITE_DIR = dirname(dirname(__FILE__));
$ETC_DIR = $CAMPSITE_DIR . '/conf';

require_once("cli_script_lib.php");

if (!camp_is_readable("$ETC_DIR/install_conf.php")) {
	exit(1);
}

// include install_conf.php file
require_once("$ETC_DIR/install_conf.php");

$usage =
"  Usage:
  campsite-utf8-converter [--help] [--log] [--silent]

  This script will convert all of your website character and text
  data in database to utf8 character set.

  Parameters:
    --help
        Show this help and exit.

    --log=LOG_FILE
        Records the sql queries in the specified file.

    --silent
        Don't display any messages on success.

  See also:
      campsite-backup
      campsite-restore

";


$silent = false;

// gets the arguments from command line, if any
for ($i = 1; isset($GLOBALS['argv'][$i]); $i++) {
    $option = explode('=', $GLOBALS['argv'][$i]);
    switch ($option[0]) {
        case '--log':
            $log_file = !empty($option[1]) ? rtrim($option[1], '/') : '';
            if (empty($log_file)) {
                echo "Error: Log file not specified!\n\n";
                echo $usage;
                exit(1);
            }
            break;
        case '--silent':
            $silent = true;
            break;
        case '--help':
            echo $usage;
            exit(0);
        default:
            echo "Error: Invalid option '" . $option[0] . "'!\n\n";
            echo $usage;
            exit(1);
    }
}

if (!$silent) {
	echo "\n";
	echo "Campsite UTF8 Converter Utility\n";
	echo "-------------------------------\n";
}

if (empty($ETC_DIR)) {
	echo $usage;
	exit(1);
}

if (!is_file("$ETC_DIR/database_conf.php")) {
	echo "\n";
	echo "Database configuration file is missing!\n";
	echo "\n";
	exit(1);
}
require_once("$ETC_DIR/database_conf.php");
require_once("cli_script_lib.php");

if (!$silent) {
        echo "UTF8 Converter script version: ".$Campsite["VERSION"]."\n";
        echo "Converting up the database...\n";
}

camp_connect_to_database();
camp_utf8_convert($log_file);

if (!$silent) {
	echo "done.\n";
}

exit(0);

?>
