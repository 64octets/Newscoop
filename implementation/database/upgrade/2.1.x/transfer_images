#/bin/sh

# configure the mysql connection variables
muser=root
mpasswd=
mserver=localhost
mclient=mysql
dbname=campsite

# configure the destination image directory
image_dir=/var/www/html/images

# configure the apache user and group
apache_user=apache
apache_group=apache


########################################################
# do not modify the following code

set -e

mcommand="$mclient -u $muser -h $mserver -N"
if [ "$mpasswd" != "" ]; then
	mcommand="$mcommand -p=\"$mpasswd\""
fi
mcommand="$mcommand $dbname"

sql="select Id from ImagesDup"
ids=`$mcommand -e "$sql"`

mkdir -p "$image_dir"
for id in $ids; do
	image_file="/tmp/cms-image-$id"
	rm -f "$image_file"
	sql="select Image into dumpfile '$image_file' from ImagesDup where Id = $id"
	$mcommand -e "$sql"
	mv -f "$image_file" "$image_dir"
done
$mcommand -e "create table TransferImages(a int)"

chown "$apache_user:$apache_group" "$image_dir" -R

echo "Images transfered succesfully into $image_dir directory."
