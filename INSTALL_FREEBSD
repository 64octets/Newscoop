Additional installation notes for FreeBSD


BEFORE INSTALLATION:

1. Campsite requires that you have 'bash' installed, with the bash executable
located at /bin/bash. If you have installed bash from ports you may wish to
simply:
	ln -s /usr/local/bin/bash /bin/bash
2. Campsite requires that you have 'stat' installed. Stat is available from the
FreeBSD ports tree under sysutils/stat.
3. To build under FreeBSD, Campsite requires that you have 'gmake' installed.
gmake is available from the FreeBSD ports tree under devel/gmake.
4. You should of course ensure that all other required Campsite components
as listed in the Campsite manual (apache, mysql, php) are installed and
correctly configured.
5. It is recommended that you change the 'configure' file in the Campsite
directory so that the line:
	export CONF_DIR=$PREFIX/etc/campsite.d/$APP_NAME

is changed to:
	export CONF_DIR=/usr/local/etc/campsite.d/$APP_NAME

This ensures that Campsite config files are stored in /usr/local/etc instead
of /etc -- probably quite desirable on most FreeBSD systems.


INSTALLATION

Follow the installation guide in the Campsite manual -- the installation
procedure on FreeBSD is exactly the same. Pay particular attention to the
following, however:

1. The mysqld should be running before you attempt to install.
2. You should run the install script as root, either using su or sudo.
3. Be aware that the Campsite installer does its best to pick reasonable
defaults in the configuration of the various modules, but that these should
always be checked by the user. (This applies when installing Campsite on
any architecture). You can change all necessary variables interactively in
the installer.

In particular, note that:
	- PARSER_USER and PARSER_GROUP should be the same as the user and group
	  you use for apache.
	- ADMIN_INTERFACE_HTML_DIR, ADMIN_INTERFACE_CGI_DIR, and
	  ADMIN_INTERFACE_SCRIPT_DIR specify where you wish to install the campsite
	  html, cgi, and scripts. On a machine with virtual hosts you will likely
	  want to choose these directories carefully.


UNINSTALLATION

Follow the guide in the Campsite manual -- the uninstallation procedure for
FreeBSD is exactly the same.


INSTALLING MULTIPLE INSTANCES

as I am in summarysing my FreeBSD experiences and campsite, I try to 
make my own campsite on FreeBSD howto.

1) Install ports, as it is quite nice to have them.

2) install following apps from ports - as far as I remember this shoud 
satisfy dependencies:
/usr/ports/www/apache2
/usr/ports/www/mod_php4
/usr/ports/shell/bash2
/usr/ports/sysutils/stat
/usr/ports/databases/mysql40-server

3) prepare campsite sources for compilation
# mkdir /usr/local/src
# cd /usr/local/src
# fetch http://www.campware.org/look/campware/download/campsite-2.1.5.tar.gz
# tar -fxz campsite-2.1.5.tar.gz

4) FreeBSD has bash binary in /usr/local/bin, while linux has it in /bin
# ln -s /usr/local/bin/bash /bin/bash

5) campsite creates directory /etc/campsite.d which holds info about 
each instalation, but FreeBSD prefers to keep it in 
/usr/local/etc/campsite.d
Even if you follow the FreeBSD readme in campsite and reconfigure the 
path in config.h in campsite sources, the binary tries using the path in 
/etc. If the path is not there (you followed the readme and redirected 
it to /usr/local/etc) campsite refuses to start.
therefore I make following symbolic link:
#ln -s /usr/local/etc/campsite.d /etc/campsite.d

6) You need working virtual host  in apache prior instalation. Note, 
that it is NOT ALLOWED to move campsite to different folder. If you want 
so, you have to recompile it using the new destination.

--- at this part I will not describe commands, but will try to lead you 
by explanation instead

a) edit /usr/local/etc/apache2/httpd.conf and enable Name Virtual Host 
(it is almost on the bottom of the file)
NameVirtualHost *:80

b) create new virtual host for the campsite site (I will copy and paste 
some working configuration)
<VirtualHost *:80>
    ServerName www.example.cz
    ServerAdmin webmaster@example.cz
    DocumentRoot /usr/local/www/virtual/www.example.cz/html/
    ErrorLog /var/log/httpd/www.example.cz-error_log
    CustomLog /var/log/httpd/www.example.cz-access_log combined
    AddHandler tpl_handler .tpl
    Action tpl_handler /cgi-bin/tpl_cgi
    IndexIgnore *
    DirectoryIndex index.html index.htm index.shtml index.php index.php4 
index.php3 index.cgi  /priv/templates/idx.php index.tpl
    Alias /icons/ /usr/local/www/virtual/www.example.cz/icons
    ScriptAlias /cgi-bin/ /usr/local/www/virtual/www.example.cz/cgi-bin/
    ScriptAlias /search/ /usr/local/www/virtual/www.example.cz/cgi-bin/
</VirtualHost>

--- note, that /var/log/httpd dir needs to be created and 
/usr/local/www/virtual/www.example.cz with subdirs too.

c) Start Apache and Mysql. At this point you can set password for root 
in MySQL and create user campsite with some password (for MySQL)
I set it personaly in following way:
- create database campsite
- create user campsite@localhost with no rights
- add database rights to user campsite to have full rights above 
database campsite except of changing rights
!!!!!!!!!!! at this point do not forget to add file access to the user 
campsite, or you will not be allowed to upload pictures
- reload database rights

d) Now you are almost ready to start compiling the campsite. I said almost.
there are some minor changes in campsite sources you need to do on FreeBSD:

What file: /usr/local/src/campsite/configure
Where: line 103
Line should look like: export CONF_DIR=/usr/local/etc/campsite.d/$APP_NAME
Why: This will direct configuration files to /usr/local/etc instead to /etc

What file: /usr/local/src/campsite/.install_conf/check4_functions
Where: line 667
Line should look like: user_line=`grep -h -w ^User 
${conf_path}/httpd.conf 2> /dev/null`
Where: line 677
Line should look like: group_line=`grep -h -w ^Group 
${conf_path}/httpd.conf 2> /dev/null`
Why: Apache on FreeBSD has several conf files in his config directory, 
so you have to specify, the user and group are defined in httpd.conf and 
not elsewhere.

e) Now you are able to start campsite install script

7) Starting install script has several minor difficulties I met:
a) When trying to find out apache config file, it fails, as it is not in 
/etc/httpd like on Linux, but in /usr/local/etc/apache2
This is not the problem, as install asks you for entering the path to 
httpd.conf
b) the preconfigured values on almost all modules are bad, so go through 
configuration
- DATABASE: You need to specify your campsite user and password. other 
values are ok.
- PARSER: User and Group are www on FreeBSD, so change both to www
- EVENT HANDLER: Should be pointed to working SMTP server which allow 
the machine send emails. If you have it on the same server, the 
localhost is fine
- ADMIN INTERFACE: all path should go to proper virtual host so change 
/var/www/html to /usr/local/www/virtual/www.example.cz/html etc.
c) Install than should be able to go through. If not, you probably 
missed something mentioned above.

8) Now the campsite shall be installed, but you need to ensure that it 
starts after reboot. Linux launches it from /etc/rc.d/rc.local script, 
however freeBSD ignores this file. Above that the syntax of the file is 
not working on FreeBSD.
I decided to forget this file and do the startup in FreeBSD way myself. 
The file can be deleted.
- campsite startup script is in /usr/local/campsite/campsitectl
- FreeBSD expect similar script in /usr/local/etc/rc.d but the script 
needs to have suffix .sh
therefore I just did:
# ln -s /usr/local/campsite/campsitectl /usr/local/etc/rc.d/campsitectl.sh

And that should be it.
---------------------------------------------------------------------------------
Now I will try to write several notes about using multiple campsite 
instances on a single server:
----------------------------------------------------------------------------------
First you need to understand, that instances needs to be independent. 
Therefore you need to have database for each and apache virtual host for 
each.
After you create all of them:
#mysqladmin create campsite1
#mysqladmin create campsite2
.....
and editing conf files in apache
you need to go through above described process for each instance you 
wish to use.

BUT THERE IS ONE IMPORTANT DIFFERENCE!!!!!!!!!!!!!

When setting PARSER and ADMIN INTERFACE modules, you need to change PORT 
settings.
There are 2 basic rules for this:
1) One instance of campsite has to have the same port for both, parser 
and admin interface
2) Two instances of campsite must not share the same port.

And that is all. No more, no less.
