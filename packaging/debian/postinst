#!/bin/bash

# postinst script for campsite

set -e

. /usr/share/debconf/confmodule

# Get all variables 

db_get campsite/db_server || true
dbserver="$RET"
#dbserver=`echo $dbserver|sed -e 's/,  */ /g'`

db_get campsite/db_adm_name || true
dbadmin="$RET"
#dbadmin=`echo $dbadmin|sed -e 's/,  */ /g'`

db_get campsite/db_adm_pass || true
dbadmpass="$RET"
#dbadmpass=`echo $dbadmpass|sed -e 's/,  */ /g'`

db_get campsite/cs_db_name || true
dbname="$RET"
#dbname=`echo $dbname|sed -e 's/,  */ /g'`

db_get campsite/cs_db_uname || true
dbuser="$RET"
#dbuser=`echo $dbuser|sed -e 's/,  */ /g'`

db_get campsite/cs_db_upass || true
dbpass="$RET"
#dbpass=`echo $dbpass|sed -e 's/,  */ /g'`

db_get campsite/site_url || true
alias="$RET"
alias=`echo $alias|sed -e 's/,  */ /g'`

db_get campsite/site_name || true
sitename="$RET"
#sitename=`echo $sitename|sed -e 's/,  */ /g'`

db_get campsite/site_pass || true
sitepass="$RET"
#sitepass=`echo $sitepass|sed -e 's/,  */ /g'`

db_get campsite/site_email || true
email="$RET"
#email=`echo $email|sed -e 's/,  */ /g'`

db_get campsite/site_demo || true
dbsample="$RET"
#dbsample=`echo $dbsample|sed -e 's/,  */ /g'`

db_get campsite/webserver || true
webserver="$RET"
#webserver=`echo $webserver|sed -e 's/,  */ /g'`


alias_config()
{
. /usr/share/debconf/confmodule || exit
db_version 2.0
db_title campsite
vhostfile=/etc/campsite/apache.conf

cat > $vhostfile <<campsite_alias_end
<VirtualHost *>
    DocumentRoot /usr/share/campsite/site

    ServerName ${alias}
    DirectoryIndex index.php index.html
    <Directory /usr/share/campsite/site>
            Options -Indexes FollowSymLinks MultiViews
            AllowOverride All
            <IfModule mod_access>
                Order allow,deny
                Allow from all
            </IfModule>
    </Directory>
</VirtualHost>
campsite_alias_end

chmod 644 $vhostfile;

}


campsite_config()
{

config_file=/usr/share/campsite/site/conf/database_conf.php
cat > $config_file << database_conf.php
<?php
/**
 * @package Campsite
 *
 * @author Holman Romero <holman.romero@gmail.com>
 * @copyright 2009 MDLF, Inc.
 * @license http://www.gnu.org/licenses/gpl.txt
 * @version \$Revision\$
 * @link http://www.campware.org
 */

global \$Campsite;

/**
 * This is only to keep backward compatibility.
 * further we will implement the use of CampConfig class
 * in the administrator.
 */
\$Campsite['DATABASE_NAME'] = '${dbname}';
\$Campsite['DATABASE_SERVER_ADDRESS'] = '${dbserver}';
\$Campsite['DATABASE_SERVER_PORT'] = '3306';
\$Campsite['DATABASE_USER'] = '${dbuser}';
\$Campsite['DATABASE_PASSWORD'] = '${dbpass}';

/** Database settings **/
\$Campsite['db']['type'] = 'mysql';
\$Campsite['db']['host'] = \$Campsite['DATABASE_SERVER_ADDRESS'];
\$Campsite['db']['port'] = \$Campsite['DATABASE_SERVER_PORT'];
\$Campsite['db']['name'] = \$Campsite['DATABASE_NAME'];
\$Campsite['db']['user'] = \$Campsite['DATABASE_USER'];
\$Campsite['db']['pass'] = \$Campsite['DATABASE_PASSWORD'];

?>
database_conf.php
chmod 644 $config_file;

}

# Installation directories

package_name="campsite"
pkgdir="/usr/share/${package_name}/"
htdocdir="${pkgdir}site/"
tpldir="${htdocdir}templates/"
installdir="${htdocdir}install/"
sampledir="${installdir}sample_templates/campsite_3.0-sample-template-01-v1/"

case "$1" in
	configure)
			
			alias_config
			campsite_config

			find /usr/share/campsite/site -type d -exec chmod 755 {} \;
			find /usr/share/campsite/site -type f -exec chmod 644 {} \;
			chown -R www-data:www-data /usr/share/campsite/site



			if [ ! -e /etc/${webserver}/conf.d/campsite ] && [ -d /etc/${webserver}/conf.d ]
			then
	   			ln -s /etc/campsite/apache.conf /etc/${webserver}/sites-available/${alias}
				ln -s /etc/${webserver}/sites-available/${alias} /etc/${webserver}/sites-enabled/
			fi
			restart="${webserver} $restart"

			server=$webserver
			servers="apache apache-ssl apache-perl apache2"
			. /usr/share/wwwconfig-common/restart.sh

			. /usr/share/wwwconfig-common/mysql-createuser.sh
			err=0
			if [ "$status" = "error" ]
			then
				err=1
				echo $error
			fi
			. /usr/share/wwwconfig-common/mysql-createdb.sh
			if [ "$status" = "error" ]
			then
				err=1
				echo $error
			fi

			case $status in
			create)
				if [ -f /usr/share/campsite/site/install/sql/campsite_core.sql ];
				then
					cat /usr/share/campsite/site/install/sql/campsite_core.sql > /tmp/campsite_core.sql
					echo "UPDATE liveuser_users SET Password = SHA1('${sitepass}'), EMail = '${email}' WHERE Id = 1;" >> /tmp/campsite_core.sql
					echo "UPDATE SystemPreferences SET value = '${sitename}' WHERE varname = 'SiteTitle';" >> /tmp/campsite_core.sql
					sqlfile=/tmp/campsite_core.sql
					. /usr/share/wwwconfig-common/mysql-exec.sh
				fi

				if [ "$dbsample" = "true" ]; then
					if [ -f /usr/share/campsite/site/install/sql/campsite_demo_data.sql ];
					then
						if [ -f /usr/share/campsite/site/install/sql/campsite_demo_tables.sql ];
						then
							cat /usr/share/campsite/site/install/sql/campsite_demo_tables.sql > /tmp/campsite_sample_data.sql
						fi
						if [ -f /usr/share/campsite/site/install/sql/campsite_demo_prepare.sql ];
						then
							cat /usr/share/campsite/site/install/sql/campsite_demo_prepare.sql >> /tmp/campsite_sample_data.sql
						fi
						if [ -f /usr/share/campsite/site/install/sql/campsite_demo_data.sql ];
						then
							cat /usr/share/campsite/site/install/sql/campsite_demo_data.sql >> /tmp/campsite_sample_data.sql
						fi
						sqlfile=/tmp/campsite_sample_data.sql
						. /usr/share/wwwconfig-common/mysql-exec.sh

						# Copies demo templates
						cp -a "${sampledir}templates/" "${htdocdir}"

						# Copies demo files
						cp -a "${sampledir}data/files/" "${htdocdir}"
						cp -a "${sampledir}data/images/" "${htdocdir}"
					fi
				fi

				if [ "$status" = "error" ]
				then
					err=1
					echo "postinst called with unknown argument \`$1'" >&2
				fi

				if [ -f /tmp/campsite_sample_data.sql ];
				then				
					rm /tmp/campsite_sample_data.sql
				fi	
				rm /tmp/campsite_core.sql
			;;
		
		nothing)
			# Don't do anything.
			;;

		error) # FIXME maybe it should depend on a mysql client
			err=1
			;;
		
		*)
			echo "Failed"
			exit 1
			;;
	esac
db_stop

if [ "$err" = "0" ]
	then
		echo "---------------------------------------------------------"
		echo "Your Campsite site has been successfully installed"
		echo "administrator user : admin"
		echo "administrator password : ${sitepass}"
		echo "Visit your site at http://localhost/${alias}"
                echo "and the Admin Panel at http://localhost/${alias}/admin/"
		echo "---------------------------------------------------------"
	fi


	;;
	abort-upgrade|abort-remove|abort-deconfigure)
	;;
	*)
		echo "postinst called with unknown argument \`$1'" >&2
		exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.


exit 0

