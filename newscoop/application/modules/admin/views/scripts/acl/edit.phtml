<?php foreach ($this->groups as $group => $groupName) { ?>
<div class="resource-group <?php echo $group; ?>">
    <h2><?php echo $groupName; ?></h2>

    <?php foreach ($this->resources[$group] as $resource => $resourceName) {
    if (!isset($this->actions[$resource])) { // skip empty
        continue;
    } ?>
    <h3><?php echo $resourceName; ?></h3>
    <ul class="resource <?php echo $resource; ?>">
        <?php foreach ($this->actions[$resource] as $action) { ?>
        <li>
            <input type="checkbox" id="_<?php echo $resource, '_', $action; ?>" name="<?php echo $resource; ?>" value="<?php echo $action; ?>" <?php echo $this->acl->isAllowed($resource, $action) ? ' checked="checked"' : ''; ?> />
            <label for="_<?php echo $resource, '_', $action; ?>"><?php echo isset($this->actionNames[$action]) ? $this->actionNames[$action] : getGS($action); ?></label>
        </li>
        <?php } ?>
    </ul>
    <?php } ?>
</div>
<?php } ?>

<script type="text/javascript">
$(function() {
    // check/uncheck all items
    $('h3 input:checkbox').change(function() {
        var checked = $(this).attr('checked');
        var context = $(this).closest('h3').next('ul');
        $('input:checkbox', context).each(function() {
            $(this).attr('checked', checked != undefined);
            $(this).change();
        });
    }).each(function() { // init
        var context = $(this).closest('h3').next('ul');
        $(this).attr('checked', $('input:checkbox', context).size() == $('input:checkbox:checked', context).size());
    });

    $('.resource-group').each(function() {
        $(this).accordion({
            header: 'h3',
            autoHeight: false,
            //event: 'mouseover'
        });
    });

    $('.resource input:checkbox').change(function() {
        var type = $(this).attr('checked') != undefined ? 'allow' : 'deny';
        var resource = $(this).attr('name');
        var action = $(this).val();

        $.post("<?php echo $this->url(array(
            'module' => 'admin',
            'controller' => 'acl',
            'action' => 'save',
            'format' => 'json',
        )); ?>", {
            'role': <?php echo $this->role; ?>,
            'type': type,
            'resource': resource,
            'action': action
        }, function(data, textStatus, jqXHR) {
            if (data.status == 'ok') {
                flashMessage(<?php echo json_encode(getGS('Permissions updated')); ?>);
            } else {
                flashMessage(<?php echo json_encode(getGS('Error: ')); ?> + data.message, 'error');
            }
        }, 'json');

        // update check all checkbox on item change
        var context = $(this).closest('ul');
        $('input:checkbox', context.prev('h3')).attr('checked', $('input:checkbox', context).size() == $('input:checkbox:checked', context).size());
    });
});
</script>
