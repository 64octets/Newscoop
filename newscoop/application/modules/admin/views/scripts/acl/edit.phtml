<?php foreach ($this->groups as $group => $groupName) { ?>
<div class="resource-group <?php echo $group; ?>">
    <h3><?php echo $groupName; ?></h3>
    <?php foreach ($this->resources[$group] as $resource => $resourceName) { ?>
    <h4><input type="checkbox" id="<?php echo $resource; ?>" /> <label for="<?php echo $resource; ?>"><?php echo $resourceName; ?></label></h4>
    <ul class="resource <?php echo $resource; ?>">
        <?php foreach ($this->actions[$resource] as $action) { ?>
        <li>
            <td><input type="checkbox" id="<?php echo $resource, '_', $action; ?>" name="<?php echo $resource; ?>" value="<?php echo $action; ?>" <?php echo $this->acl->isAllowed($resource, $action) ? ' checked="checked"' : ''; ?> />
            <label for="<?php echo $resource, '_', $action; ?>"><?php putGS($action); ?></label></td>
        </li>
        <?php } ?>
    </ul>
    <?php } ?>
</div>
<?php } ?>

<script type="text/javascript">
$(function() {
    // check/uncheck all items
    $('.resource th input:checkbox').change(function() {
        var checked = $(this).attr('checked');
        var table = $(this).closest('table');
        $('td input:checkbox', table).each(function() {
            $(this).attr('checked', checked != undefined);
            $(this).change();
        });
    }).each(function() { // init
        var table = $(this).closest('table');
        $(this).attr('checked', $('td input:checkbox', table).size() == $('td input:checkbox:checked', table).size());
    });

    $('.resource-group').each(function() {
        $(this).accordion({
            header: 'h4',
            autoHeight: false,
            event: 'mouseover'
        });
    });

    $('.resource td input:checkbox').change(function() {
        var type = $(this).attr('checked') != undefined ? 'allow' : 'deny';
        var resource = $(this).attr('name');
        var action = $(this).val();

        $.post("<?php echo $this->url(array(
            'module' => 'admin',
            'controller' => 'acl',
            'action' => 'save',
            'format' => 'json',
        )); ?>", {
            'role': <?php echo $this->role; ?>,
            'type': type,
            'resource': resource,
            'action': action
        }, function(data, textStatus, jqXHR) {
            if (data.status == 'ok') {
                flashMessage(<?php echo json_encode(getGS('Permissions updated')); ?>);
            } else {
                flashMessage(<?php echo json_encode(getGS('Error: ')); ?> + data.message, 'error');
            }
        }, 'json');

        // update check all checkbox on item change
        var table = $(this).closest('table');
        $('th input:checkbox', table).attr('checked', $('td input:checkbox', table).size() == $('td input:checkbox:checked', table).size());
    });
});
</script>
